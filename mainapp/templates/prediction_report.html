<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prediction Report</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <!-- DataTables Buttons CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <!-- Chart.js CSS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <!-- DataTables Buttons JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <!-- JSZip for CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <!-- Buttons HTML5 export JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Prediction Report</h1>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% else %}
            <p>Model Accuracy: {{ accuracy }}</p>
            
            <!-- Filter Dropdowns -->
            <div class="form-group">
                <label for="eventTypeFilter">Filter by EventType:</label>
                <select id="eventTypeFilter" class="form-control">
                    <option value="">All</option>
                    <option value="Error">Error</option>
                    <option value="Warning">Warning</option>
                </select>
            </div>

            <!-- Chart Container -->
            <div class="my-4">
                <canvas id="eventChart"></canvas>
            </div>

            <table id="predictionTable" class="display table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>EventID</th>
                        <th>EventType</th>
                        <th>Predicted_Probability</th>
                        <th>Next_Occurrence</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in report %}
                        <tr>
                            <td>{{ record.Date }}</td>
                            <td>{{ record.EventID }}</td>
                            <td>{{ record.EventType }}</td>
                            <td>{{ record.Predicted_Probability }}</td>
                            <td>{{ record.Next_Occurrence }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <script>
        $(document).ready(function() {
            var table = $('#predictionTable').DataTable({
                "order": [[ 0, "desc" ]], // Order by Date column descending
                dom: 'Bfrtip', // Show buttons
                buttons: [
                    {
                        extend: 'csvHtml5',
                        text: 'Download CSV',
                        exportOptions: {
                            columns: ':visible',
                            modifier: {
                                search: 'applied',  // Use the filtered data
                                order: 'applied'
                            }
                        }
                    }
                ]
            });

            // EventType filter
            $('#eventTypeFilter').on('change', function() {
                var selected = $(this).val();
                if (selected) {
                    table.column(2).search('^' + selected + '$', true, false).draw();
                } else {
                    table.column(2).search('').draw();
                }
            });

            // Prepare data for Chart.js
            var eventTypeData = {
                Error: table.column(2).data().filter(item => item === 'Error').length,
                Warning: table.column(2).data().filter(item => item === 'Warning').length
            };

            // Initialize Chart.js
            var ctx = document.getElementById('eventChart').getContext('2d');
            var eventChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Error', 'Warning'],
                    datasets: [{
                        label: 'Event Count',
                        data: [eventTypeData.Error, eventTypeData.Warning],
                        backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
