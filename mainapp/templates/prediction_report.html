<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prediction Report</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <!-- DataTables Buttons CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <!-- DataTables Buttons JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <!-- JSZip for CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <!-- Buttons HTML5 export JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Prediction Report</h1>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% else %}
            <p>Model Accuracy: {{ accuracy }}</p>
            <p>Model F1 Score: {{ f1 }}</p>
            
            <div class="alert alert-info">
                <h4>Data Usage Information:</h4>
                <p>Training Period: {{ training_start }} to {{ training_end }}</p>
                <p>Validation Period: {{ validation_start }} to {{ validation_end }}</p>
            </div>
            
            <!-- Filter Dropdowns -->
            <div class="form-group">
                <label for="eventTypeFilter">Filter by EventType:</label>
                <select id="eventTypeFilter" class="form-control">
                    <option value="">All</option>
                    <option value="Error">Error</option>
                    <option value="Warning">Warning</option>
                </select>
            </div>

            <!-- Chart Container -->
            <div class="my-4">
                <canvas id="eventChart"></canvas>
            </div>

            <!-- DataTable -->
            <table id="predictionTable" class="display table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>EventID</th>
                        <th>EventType</th>
                        <th>Predicted Probability (%)</th>
                        <th>Next Occurrence</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in report %}
                        <tr>
                            <td>{{ record.Date }}</td>
                            <td>{{ record.EventID }}</td>
                            <td>{{ record.EventType }}</td>
                            <td>{{ record.Predicted_Probability|floatformat:2 }}</td>
                            <td>{{ record.Next_Occurrence }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    <script>
        $(document).ready(function() {
            var table = $('#predictionTable').DataTable({
                "order": [[ 4, "asc" ]], // Order by Next Occurrence column ascending
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csvHtml5',
                        text: 'Download CSV',
                        exportOptions: {
                            columns: ':visible',
                            modifier: {
                                search: 'applied',
                                order: 'applied'
                            }
                        }
                    }
                ]
            });

            $('#eventTypeFilter').on('change', function() {
                var selected = $(this).val();
                table.column(2).search(selected ? '^' + selected + '$' : '', true, false).draw();
                updateChart();
            });

            // Parse the chart data
            var chartData = JSON.parse('{{ chart_data|safe }}');

            var chartOptions = {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Probability (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Next Occurrence Date'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Prediction vs Actual Data Timeline\nTraining: {{ training_start }} to {{ training_end }}\nValidation: {{ validation_start }} to {{ validation_end }}',
                        font: {
                            size: 14
                        }
                    }
                }
            };

            // Initialize Chart.js
            var ctx = document.getElementById('eventChart').getContext('2d');
            var eventChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: chartOptions
            });

            function updateChart() {
                var filteredData = table.rows({ search: 'applied' }).data().toArray();
                var labels = [];
                var errorData = [];
                var warningData = [];

                filteredData.forEach(function(row) {
                    labels.push(row[4]); // Next Occurrence date
                    if (row[2] === 'Error') {
                        errorData.push(parseFloat(row[3]));
                        warningData.push(0);
                    } else {
                        errorData.push(0);
                        warningData.push(parseFloat(row[3]));
                    }
                });

                eventChart.data.labels = labels;
                eventChart.data.datasets[0].data = errorData;
                eventChart.data.datasets[1].data = warningData;
                eventChart.update();
            }
        });
    </script>
</body>
</html>